name: Build and Release Packages

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-deb:
    name: Build Debian Package
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y debhelper devscripts build-essential

      - name: Build Debian package
        run: |
          dpkg-buildpackage -us -uc -b

      - name: Move artifacts
        run: |
          mkdir -p dist
          mv ../cvm-cli_*.deb dist/
          mv ../cvm-cli_*.buildinfo dist/
          mv ../cvm-cli_*.changes dist/

      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        with:
          name: debian-package
          path: dist/*.deb

  build-rpm:
    name: Build RPM Package
    runs-on: ubuntu-latest
    container: fedora:latest
    steps:
      - name: Install Git and dependencies
        run: |
          dnf install -y git rpm-build rpmdevtools make jq curl openssl qemu-img python3

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup RPM build environment
        run: |
          rpmdev-setuptree
          tar czf ~/rpmbuild/SOURCES/cvm-cli-0.1.0.tar.gz \
            --transform 's,^,cvm-cli-0.1.0/,' \
            --exclude=.git \
            --exclude=dist \
            .

      - name: Build RPM
        run: |
          rpmbuild -bb cvm-cli.spec

      - name: Move artifacts
        run: |
          mkdir -p dist
          cp ~/rpmbuild/RPMS/noarch/cvm-cli-*.rpm dist/

      - name: Upload RPM package
        uses: actions/upload-artifact@v4
        with:
          name: rpm-package
          path: dist/*.rpm

  create-release:
    name: Create GitHub Release
    needs: [build-deb, build-rpm]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Debian package
        uses: actions/download-artifact@v4
        with:
          name: debian-package
          path: dist/

      - name: Download RPM package
        uses: actions/download-artifact@v4
        with:
          name: rpm-package
          path: dist/

      - name: Generate checksums
        run: |
          cd dist
          sha256sum *.deb *.rpm > SHA256SUMS
          cat SHA256SUMS

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_type == 'tag' && github.ref_name || 'v0.1.0' }}
          files: |
            dist/*.deb
            dist/*.rpm
            dist/SHA256SUMS
          body: |
            ## cvm-cli ${{ github.ref_type == 'tag' && github.ref_name || 'v0.1.0' }}

            This release contains the **CLI packages only** (`.deb` and `.rpm`).
            Disk images are released separately - the CLI will automatically find and download them.

            ### Installation (Private Repository)

            This is a private repository. You need a GitHub personal access token with `repo` scope.

            **Ubuntu/Debian:**
            ```bash
            # Set your GitHub token and release tag
            export GITHUB_TOKEN=your_github_token_here
            export RELEASE_TAG=${{ github.ref_type == 'tag' && github.ref_name || 'v0.1.0' }}

            # Get release info and download .deb package
            RELEASE_INFO=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/automata-network/cvm-base-image/releases/tags/$RELEASE_TAG")
            ASSET_ID=$(echo "$RELEASE_INFO" | jq '.assets[] | select(.name | endswith(".deb")) | .id')
            DEB_NAME=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | endswith(".deb")) | .name')

            curl -L -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/octet-stream" \
              "https://api.github.com/repos/automata-network/cvm-base-image/releases/assets/$ASSET_ID" \
              -o "$DEB_NAME"

            # Install
            sudo dpkg -i "$DEB_NAME"
            sudo apt-get install -f
            ```

            **Fedora/RHEL:**
            ```bash
            # Set your GitHub token and release tag
            export GITHUB_TOKEN=your_github_token_here
            export RELEASE_TAG=${{ github.ref_type == 'tag' && github.ref_name || 'v0.1.0' }}

            # Get release info and download .rpm package
            RELEASE_INFO=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/automata-network/cvm-base-image/releases/tags/$RELEASE_TAG")
            ASSET_ID=$(echo "$RELEASE_INFO" | jq '.assets[] | select(.name | endswith(".rpm")) | .id')
            RPM_NAME=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | endswith(".rpm")) | .name')

            curl -L -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/octet-stream" \
              "https://api.github.com/repos/automata-network/cvm-base-image/releases/assets/$ASSET_ID" \
              -o "$RPM_NAME"

            # Install
            sudo dnf install "./$RPM_NAME"
            ```

            **Alternative: Using GitHub CLI**
            ```bash
            gh release download ${{ github.ref_type == 'tag' && github.ref_name || 'v0.1.0' }} --repo automata-network/cvm-base-image --pattern "*.deb"
            sudo dpkg -i cvm-cli_*.deb
            sudo apt-get install -f
            ```

            ### Usage

            After installation, set your GitHub token and run:
            ```bash
            export GITHUB_TOKEN=your_github_token_here
            cvm-cli deploy-gcp    # Deploy to GCP
            cvm-cli deploy-aws    # Deploy to AWS
            cvm-cli deploy-azure  # Deploy to Azure
            ```

            The CLI will automatically find and download the latest disk image from image releases.

            ### What's New
            - Initial release of cvm-cli
            - Support for AWS, GCP, and Azure deployments
            - SLSA attestation verification
            - Automatic detection of latest image release

            ### Verify Downloads
            ```bash
            sha256sum -c SHA256SUMS
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
