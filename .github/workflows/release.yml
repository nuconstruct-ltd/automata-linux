name: Build and Release Packages

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-deb:
    name: Build Debian Package
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y debhelper devscripts build-essential

      - name: Update version in changelog
        run: |
          # Extract version from git tag (e.g., v0.1.2 -> 0.1.2) or default to 0.1.0
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix
          else
            VERSION="0.1.0"
          fi
          echo "Building Debian package version: $VERSION"
          # Update the version in debian/changelog
          sed -i "s/^cvm-cli ([^)]*)/cvm-cli (${VERSION}-1)/" debian/changelog
          head -1 debian/changelog

      - name: Build Debian package
        run: |
          dpkg-buildpackage -us -uc -b

      - name: Move artifacts
        run: |
          mkdir -p dist
          mv ../cvm-cli_*.deb dist/
          mv ../cvm-cli_*.buildinfo dist/
          mv ../cvm-cli_*.changes dist/

      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        with:
          name: debian-package
          path: dist/*.deb

  build-macos:
    name: Build macOS Package (ARM64)
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Create macOS tarball
        run: |
          # Extract version from git tag (e.g., v0.1.2 -> 0.1.2) or default to 0.1.0
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix
          else
            VERSION="0.1.0"
          fi
          echo "Building macOS package version: $VERSION"
          PKG_NAME="cvm-cli-${VERSION}-macos-arm64"
          mkdir -p "${PKG_NAME}/bin"
          mkdir -p "${PKG_NAME}/share/cvm-cli/scripts"
          mkdir -p "${PKG_NAME}/share/cvm-cli/tools"
          mkdir -p "${PKG_NAME}/share/cvm-cli/workload/config/cvm_agent"

          # Copy files
          cp cvm-cli "${PKG_NAME}/bin/"
          cp scripts/*.sh "${PKG_NAME}/share/cvm-cli/scripts/"
          cp tools/json_sig_tool.py "${PKG_NAME}/share/cvm-cli/tools/"
          cp workload/docker-compose.yml "${PKG_NAME}/share/cvm-cli/workload/"
          cp workload/config/cvm_agent/*.json "${PKG_NAME}/share/cvm-cli/workload/config/cvm_agent/"
          cp workload/config/*.yml "${PKG_NAME}/share/cvm-cli/workload/config/"
          cp workload/config/*.conf "${PKG_NAME}/share/cvm-cli/workload/config/"
          cp README.md LICENSE "${PKG_NAME}/"

          # Create install script
          cat > "${PKG_NAME}/install.sh" << 'INSTALL_EOF'
          #!/bin/bash
          set -e
          PREFIX="${PREFIX:-/usr/local}"
          cp -r bin/* "${PREFIX}/bin/"
          mkdir -p "${PREFIX}/share/cvm-cli"
          cp -r share/cvm-cli/* "${PREFIX}/share/cvm-cli/"
          echo "âœ… cvm-cli installed to ${PREFIX}"
          INSTALL_EOF
          chmod +x "${PKG_NAME}/install.sh"

          # Create tarball
          tar -czvf "${PKG_NAME}.tar.gz" "${PKG_NAME}"
          mkdir -p dist
          mv "${PKG_NAME}.tar.gz" dist/

      - name: Upload macOS package
        uses: actions/upload-artifact@v4
        with:
          name: macos-package
          path: dist/*.tar.gz

  create-release:
    name: Create GitHub Release
    needs: [build-deb, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Debian package
        uses: actions/download-artifact@v4
        with:
          name: debian-package
          path: dist/

      - name: Download macOS package
        uses: actions/download-artifact@v4
        with:
          name: macos-package
          path: dist/

      - name: Generate checksums
        run: |
          cd dist
          sha256sum *.deb *.tar.gz > SHA256SUMS
          cat SHA256SUMS

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_type == 'tag' && github.ref_name || 'v0.1.0' }}
          files: |
            dist/*.deb
            dist/*.tar.gz
            dist/SHA256SUMS
          body: |
            ## cvm-cli ${{ github.ref_type == 'tag' && github.ref_name || 'v0.1.0' }}

            This release contains the **CLI packages only** (`.deb` and `.tar.gz`).
            Disk images are released separately - the CLI will automatically find and download them.

            ### Installation (Private Repository)

            This is a private repository. You need a GitHub personal access token with `repo` scope.

            **Ubuntu/Debian:**
            ```bash
            # Set your GitHub token and release tag
            export GITHUB_TOKEN=your_github_token_here
            export RELEASE_TAG=${{ github.ref_type == 'tag' && github.ref_name || 'v0.1.0' }}

            # Get release info and download .deb package
            RELEASE_INFO=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/automata-network/cvm-base-image/releases/tags/$RELEASE_TAG")
            ASSET_ID=$(echo "$RELEASE_INFO" | jq '.assets[] | select(.name | endswith(".deb")) | .id')
            DEB_NAME=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | endswith(".deb")) | .name')

            curl -L -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/octet-stream" \
              "https://api.github.com/repos/automata-network/cvm-base-image/releases/assets/$ASSET_ID" \
              -o "$DEB_NAME"

            # Install
            sudo dpkg -i "$DEB_NAME"
            sudo apt-get install -f
            ```

            **Alternative: Using GitHub CLI**
            ```bash
            gh release download ${{ github.ref_type == 'tag' && github.ref_name || 'v0.1.0' }} --repo automata-network/cvm-base-image --pattern "*.deb"
            sudo dpkg -i cvm-cli_*.deb
            sudo apt-get install -f
            ```

            **macOS (ARM64 only via Homebrew):**
            ```bash
            # Set your GitHub token (requires repo scope)
            export HOMEBREW_GITHUB_API_TOKEN=your_github_token_here

            # Tap and install
            brew tap automata-network/cvm-base-image https://github.com/automata-network/cvm-base-image
            brew install cvm-cli
            ```

            > **Tip:** If you use GitHub CLI, you can get your token with: `export HOMEBREW_GITHUB_API_TOKEN=$(gh auth token)`

            ### Usage

            After installation, set your GitHub token and run:
            ```bash
            export GITHUB_TOKEN=your_github_token_here
            cvm-cli deploy-gcp    # Deploy to GCP
            cvm-cli deploy-aws    # Deploy to AWS
            cvm-cli deploy-azure  # Deploy to Azure
            ```

            The CLI will automatically find and download the latest disk image from image releases.

            ### What's New
            - Initial release of cvm-cli
            - Support for AWS, GCP, and Azure deployments
            - SLSA attestation verification
            - Automatic detection of latest image release

            ### Verify Downloads
            ```bash
            sha256sum -c SHA256SUMS
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew-formula:
    name: Update Homebrew Formula
    needs: [create-release]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Get release asset info
        id: asset-info
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.ref_type == 'tag' && github.ref_name || 'v0.1.0' }}"

          # Get release info
          RELEASE_INFO=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG")

          # Find the macOS ARM64 tarball asset
          ASSET_ID=$(echo "$RELEASE_INFO" | jq '.assets[] | select(.name | contains("macos-arm64")) | .id')
          ASSET_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | contains("macos-arm64")) | .browser_download_url')

          if [ -z "$ASSET_ID" ] || [ "$ASSET_ID" = "null" ]; then
            echo "Error: Could not find macOS ARM64 asset"
            exit 1
          fi

          # Download the asset to compute SHA256
          curl -L -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/octet-stream" \
            "https://api.github.com/repos/${{ github.repository }}/releases/assets/$ASSET_ID" \
            -o macos-arm64.tar.gz

          SHA256=$(sha256sum macos-arm64.tar.gz | awk '{print $1}')

          echo "asset_id=$ASSET_ID" >> $GITHUB_OUTPUT
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Found asset ID: $ASSET_ID"
          echo "SHA256: $SHA256"

      - name: Update formula
        run: |
          sed -i "s/ASSET_ID_PLACEHOLDER/${{ steps.asset-info.outputs.asset_id }}/g" Formula/cvm-cli.rb
          sed -i "s/SHA256_PLACEHOLDER/${{ steps.asset-info.outputs.sha256 }}/g" Formula/cvm-cli.rb
          cat Formula/cvm-cli.rb

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update Homebrew formula for ${{ steps.asset-info.outputs.tag }}"
          title: "chore: update Homebrew formula for ${{ steps.asset-info.outputs.tag }}"
          body: |
            Automated PR to update the Homebrew formula with the correct asset ID and SHA256 for release ${{ steps.asset-info.outputs.tag }}.

            - Asset ID: `${{ steps.asset-info.outputs.asset_id }}`
            - SHA256: `${{ steps.asset-info.outputs.sha256 }}`
          branch: update-homebrew-formula-${{ steps.asset-info.outputs.tag }}
          base: main
