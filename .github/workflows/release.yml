name: Build and Release Packages

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-deb:
    name: Build Debian Package
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y debhelper devscripts build-essential

      - name: Update version in changelog
        run: |
          # Extract version from git tag (e.g., v0.1.2 -> 0.1.2) or default to 0.1.0
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix
          else
            VERSION="0.1.0"
          fi
          echo "Building Debian package version: $VERSION"
          # Update the version in debian/changelog
          sed -i "s/^atakit ([^)]*)/atakit (${VERSION}-1)/" debian/changelog
          head -1 debian/changelog

      - name: Build Debian package
        run: |
          dpkg-buildpackage -us -uc -b

      - name: Move artifacts
        run: |
          mkdir -p dist
          mv ../atakit_*.deb dist/
          mv ../atakit_*.buildinfo dist/
          mv ../atakit_*.changes dist/

      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        with:
          name: debian-package
          path: dist/*.deb

  build-macos:
    name: Build macOS Package (ARM64)
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Create macOS tarball
        run: |
          # Extract version from git tag (e.g., v0.1.2 -> 0.1.2) or default to 0.1.0
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix
          else
            VERSION="0.1.0"
          fi
          echo "Building macOS package version: $VERSION"
          PKG_NAME="atakit-${VERSION}-macos-arm64"
          mkdir -p "${PKG_NAME}/bin"
          mkdir -p "${PKG_NAME}/share/atakit/scripts"
          mkdir -p "${PKG_NAME}/share/atakit/tools"
          mkdir -p "${PKG_NAME}/share/atakit/workload/config/cvm_agent"

          # Copy files
          cp atakit "${PKG_NAME}/bin/"
          cp scripts/*.sh "${PKG_NAME}/share/atakit/scripts/"
          cp tools/json_sig_tool.py "${PKG_NAME}/share/atakit/tools/"
          cp workload/docker-compose.yml "${PKG_NAME}/share/atakit/workload/"
          cp workload/config/cvm_agent/*.json "${PKG_NAME}/share/atakit/workload/config/cvm_agent/"
          cp workload/config/*.yml "${PKG_NAME}/share/atakit/workload/config/"
          cp workload/config/*.conf "${PKG_NAME}/share/atakit/workload/config/"
          cp README.md LICENSE "${PKG_NAME}/"

          # Create install script
          cat > "${PKG_NAME}/install.sh" << 'INSTALL_EOF'
          #!/bin/bash
          set -e
          PREFIX="${PREFIX:-/usr/local}"
          cp -r bin/* "${PREFIX}/bin/"
          mkdir -p "${PREFIX}/share/atakit"
          cp -r share/atakit/* "${PREFIX}/share/atakit/"
          echo "âœ… atakit installed to ${PREFIX}"
          INSTALL_EOF
          chmod +x "${PKG_NAME}/install.sh"

          # Create tarball
          tar -czvf "${PKG_NAME}.tar.gz" "${PKG_NAME}"
          mkdir -p dist
          mv "${PKG_NAME}.tar.gz" dist/

      - name: Upload macOS package
        uses: actions/upload-artifact@v4
        with:
          name: macos-package
          path: dist/*.tar.gz

  create-release:
    name: Create GitHub Release
    needs: [build-deb, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Debian package
        uses: actions/download-artifact@v4
        with:
          name: debian-package
          path: dist/

      - name: Download macOS package
        uses: actions/download-artifact@v4
        with:
          name: macos-package
          path: dist/

      - name: Generate checksums
        run: |
          cd dist
          sha256sum *.deb *.tar.gz > SHA256SUMS
          cat SHA256SUMS

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_type == 'tag' && github.ref_name || 'v0.1.0' }}
          files: |
            dist/*.deb
            dist/*.tar.gz
            dist/SHA256SUMS
          body: |
            ## atakit ${{ github.ref_type == 'tag' && github.ref_name || 'v0.1.0' }}

            This release contains the **CLI packages only** (`.deb` and `.tar.gz`).
            Disk images are released separately - the CLI will automatically find and download them.

            ### Installation

            **Ubuntu/Debian:**
            ```bash
            # Set the release tag
            export RELEASE_TAG=${{ github.ref_type == 'tag' && github.ref_name || 'v0.1.0' }}

            # Download and install
            curl -LO "https://github.com/automata-network/automata-linux/releases/download/${RELEASE_TAG}/atakit_${RELEASE_TAG}_amd64.deb"
            sudo dpkg -i atakit_*.deb
            sudo apt-get install -f
            ```

            **macOS (ARM64 only via Homebrew):**
            ```bash
            brew tap automata-network/automata-linux
            brew install atakit
            ```

            ### Usage

            After installation, run:
            ```bash
            atakit deploy-gcp    # Deploy to GCP
            atakit deploy-aws    # Deploy to AWS
            atakit deploy-azure  # Deploy to Azure
            ```

            The CLI will automatically find and download the latest disk image from image releases.

            ### What's New
            - Initial release of atakit
            - Support for AWS, GCP, and Azure deployments
            - SLSA attestation verification
            - Automatic detection of latest image release

            ### Verify Downloads
            ```bash
            sha256sum -c SHA256SUMS
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew-formula:
    name: Update Homebrew Formula
    needs: [create-release]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Get release asset info
        id: asset-info
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.ref_type == 'tag' && github.ref_name || 'v0.1.0' }}"

          # Get release info
          RELEASE_INFO=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG")

          # Find the macOS ARM64 tarball asset
          ASSET_ID=$(echo "$RELEASE_INFO" | jq '.assets[] | select(.name | contains("macos-arm64")) | .id')
          ASSET_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | contains("macos-arm64")) | .browser_download_url')

          if [ -z "$ASSET_ID" ] || [ "$ASSET_ID" = "null" ]; then
            echo "Error: Could not find macOS ARM64 asset"
            exit 1
          fi

          # Download the asset to compute SHA256
          curl -L -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/octet-stream" \
            "https://api.github.com/repos/${{ github.repository }}/releases/assets/$ASSET_ID" \
            -o macos-arm64.tar.gz

          SHA256=$(sha256sum macos-arm64.tar.gz | awk '{print $1}')

          echo "asset_id=$ASSET_ID" >> $GITHUB_OUTPUT
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Found asset ID: $ASSET_ID"
          echo "SHA256: $SHA256"

      - name: Update formula
        run: |
          TAG="${{ steps.asset-info.outputs.tag }}"
          VERSION="${TAG#v}"  # Remove 'v' prefix
          SHA256="${{ steps.asset-info.outputs.sha256 }}"

          # Update version (URL uses #{version} interpolation so only version needs updating)
          sed -i "s/version \"[^\"]*\"/version \"${VERSION}\"/" Formula/atakit.rb
          # Update SHA256
          sed -i "s/sha256 \"[a-f0-9]*\"/sha256 \"${SHA256}\"/" Formula/atakit.rb

          echo "Updated formula:"
          cat Formula/atakit.rb

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update Homebrew formula for ${{ steps.asset-info.outputs.tag }}"
          title: "chore: update Homebrew formula for ${{ steps.asset-info.outputs.tag }}"
          body: |
            Automated PR to update the Homebrew formula for release ${{ steps.asset-info.outputs.tag }}.

            - SHA256: `${{ steps.asset-info.outputs.sha256 }}`
          branch: update-homebrew-formula-${{ steps.asset-info.outputs.tag }}
          base: main
