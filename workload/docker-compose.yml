version: "3.8"

networks:
  node_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
  monitoring:
    driver: bridge

services:
  tool-node:
    image: ${TOOL_NODE_IMAGE:-gcr.io/constellation-458212/tool-node:tool-dns}
    container_name: tool-node
    restart: unless-stopped
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:24224
        tag: container.tool-node
        fluentd-async: "true"
    ports:
      - 8545:8545/tcp
      - 8546:8546/tcp
      - 8551:8551/tcp
      - 30303:30303/tcp
      - 30303:30303/udp
      - 9060:9060/tcp
      - 6060:6060/tcp
    volumes:
      - /data/data-disk/node:/node
      - ./secrets/nodekey:/node/nodekey:ro
    networks:
      monitoring: {}
      node_net:
        ipv4_address: 172.20.0.10
    command: >-
      --hoodi
      --datadir=/node
      --nodekey=/node/nodekey
      --authrpc.jwtsecret=/node/jwtsecret
      --http.api=engine,eth,web3,net,tool,admin
      --ws.api=engine,eth,web3,net
      --metrics
      --metrics.addr=0.0.0.0
      --metrics.port=6060
      --config=default
      --discovery.tool-dns=${TOOL_DNS_ENDPOINT:-enrtree://AO7WHA56ZB2MZZZ2IAM5NIX7FUMAIHYQXYY33HUZ2K4BMCKBZWZAQ@tool.hoodi.sdoba.vip}
      --relay.beacon-endpoints=http://lighthouse:5052
      --relay.secret-key-hex=${RELAY_SECRET_KEY:-28c3cd61b687fdd03488e167a5d84f50269df2a4c29a2cfb1390903aa775c5d0}
      --public-sync
      --tee-verifier=${TEE_VERIFIER_ADDRESS:-0xd177e09fB4Db2379F55E177047F38f5a7F44AEAe}
      --history.blocks=${HISTORY_BLOCKS:-512}
      --history.chain=${HISTORY_CHAIN:-all}

  lighthouse:
    image: ${LIGHTHOUSE_IMAGE:-docker.io/sigp/lighthouse:latest}
    container_name: lighthouse
    restart: unless-stopped
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:24224
        tag: container.lighthouse
        fluentd-async: "true"
    ports:
      - 9000:9000/tcp
      - 9000:9000/udp
      - 5054:5054/tcp
    networks:
      - monitoring
      - node_net
    volumes:
      - /data/data-disk/node:/node
    command: >-
      lighthouse bn
      --datadir /node
      --execution-jwt=/node/jwtsecret
      --execution-endpoint=http://tool-node:8551
      --disable-upnp
      --disable-enr-auto-update
      --enr-tcp-port=9000
      --enr-udp-port=9000
      --listen-address=0.0.0.0
      --port=9000
      --discovery-port=9000
      --http
      --http-address=0.0.0.0
      --http-port=5052
      --metrics
      --metrics-address=0.0.0.0
      --metrics-port=5054
      --checkpoint-sync-url=${CHECKPOINT_SYNC_URL:-https://checkpoint-sync.hoodi.ethpandaops.io}
      --network=${LIGHTHOUSE_NETWORK:-hoodi}
      --always-prepare-payload
      --prepare-payload-lookahead=12000
      --suggested-fee-recipient=${FEE_RECIPIENT:-0x00000000000000000000000000000000DeaDBeef}

  node-exporter:
    image: ${NODE_EXPORTER_IMAGE:-docker.io/prom/node-exporter:v1.9.1}
    container_name: node-exporter
    restart: unless-stopped
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:24224
        tag: container.node-exporter
        fluentd-async: "true"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - "--path.procfs=/host/proc"
      - "--path.rootfs=/rootfs"
      - "--path.sysfs=/host/sys"
      - "--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)"
    ports:
      - 9100:9100/tcp
    networks:
      - monitoring

  fluent-bit:
    image: ${FLUENT_BIT_IMAGE:-docker.io/fluent/fluent-bit:latest}
    container_name: fluent-bit
    restart: unless-stopped
    volumes:
      - ./config/fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf:ro
      - /var/log:/var/log:ro
      - /run/log/journal:/run/log/journal:ro
      - /etc/machine-id:/etc/machine-id:ro
    environment:
      - HOSTNAME=${HOSTNAME}
      - VM_NAME=${VM_NAME:-cvm}
      - LOKI_HOST=${LOKI_HOST:-loki.example.com}
      - LOKI_PORT=${LOKI_PORT:-3100}
      - LOKI_TLS=${LOKI_TLS:-Off}
    ports:
      - 24224:24224/tcp
      - 24224:24224/udp
    networks:
      - monitoring

  controller:
    image: ${CONTROLLER_IMAGE:-gcr.io/constellation-458212/controller:latest}
    pull_policy: never
    container_name: controller
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:24224
        tag: container.controller
        fluentd-async: "true"
    cap_add:
      - NET_ADMIN
    ports:
      - "8080:8080"
      - "2222:22"
    environment:
      - TOOL_NODE_IP=172.20.0.10
      - NODE_NET_SUBNET=172.20.0.0/24
      - PORT=8080
    networks:
      node_net:
        ipv4_address: 172.20.0.20

  operator:
    image: ${OPERATOR_IMAGE:-gcr.io/constellation-458212/operator:latest}
    pull_policy: never
    container_name: operator
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:24224
        tag: container.operator
        fluentd-async: "true"
    network_mode: "service:controller"
    depends_on:
      - controller
    volumes:
      - /data/workload/config:/config

  caddy:
    image: ${CADDY_IMAGE:-docker.io/library/caddy:latest}
    container_name: caddy
    restart: unless-stopped
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:24224
        tag: container.caddy
        fluentd-async: "true"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./config/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - node_net
    extra_hosts:
      - "host.docker.internal:host-gateway"

volumes:
  caddy_data:
  caddy_config:
